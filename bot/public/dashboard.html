<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TradingView Signal Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    label, select, input, button { display: block; margin: 10px 0; }
    input, select { padding: 8px; width: 100%; max-width: 300px; }
    button { padding: 10px 20px; background: #1a73e8; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background: #155ab6; }
    #logs, #stats, #captureStatus { margin-top: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); max-width: 600px; }
    ul { padding-left: 20px; }
    #lastCapture { max-width: 100%; margin-top: 10px; display: none; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>ðŸ“ˆ Trading Dashboard</h1>

  <!-- Trade form -->
  <form id="tradeForm">
    <label for="pair">Currency/OTC Pair</label>
    <select id="pair" name="pair" required>
      <option value="EUR/USD">EUR/USD</option>
      <option value="GBP/USD">GBP/USD</option>
      <option value="USD/JPY">USD/JPY</option>
      <option value="EUR/GBP">EUR/GBP</option>
      <option value="OTC/EURJPY">OTC/EURJPY</option>
      <!-- add more pairs here -->
    </select>

    <label for="expiry">Expiry Time (min)</label>
    <select id="expiry" name="expiry" required>
      <option value="1">1</option>
      <option value="3">3</option>
      <option value="5">5</option>
      <option value="15">15</option>
    </select>

    <label for="amount">Amount ($ or %)</label>
    <input type="text" id="amount" name="amount" placeholder="e.g. 5 or 5%" required />

    <label for="stopLoss">Stop Loss (%)</label>
    <input type="number" id="stopLoss" name="stopLoss" min="0" max="100" step="0.1" placeholder="e.g. 2" />

    <label for="takeProfit">Take Profit (%)</label>
    <input type="number" id="takeProfit" name="takeProfit" min="0" max="100" step="0.1" placeholder="e.g. 5" />

    <button type="submit">Place Trade</button>
  </form>

  <!-- Manual capture -->
  <button id="captureBtn">ðŸ“¸ Capture Chart & Send to Telegram</button>
  <div id="captureStatus">Idle</div>
  <img id="lastCapture" alt="Last captured chart" />

  <!-- Trade log -->
  <div id="logs">
    <h3>ðŸ“„ Trade Logs</h3>
    <ul id="tradeLogList"></ul>
  </div>

  <!-- Trade result update -->
  <div id="resultUpdate" style="margin-top:30px; max-width: 400px;">
    <h3>Update Trade Result</h3>
    <label for="tradeTimestamp">Trade Timestamp (ms)</label>
    <input type="number" id="tradeTimestamp" placeholder="Timestamp from trade log" />

    <label for="tradeResult">Result</label>
    <select id="tradeResult">
      <option value="win">Win</option>
      <option value="loss">Loss</option>
    </select>

    <button id="updateResultBtn">Update Result</button>
  </div>

  <!-- Stats -->
  <div id="stats">
    <h3>ðŸ“Š Stats</h3>
    <p>Total Trades: <span id="statTotal">0</span></p>
    <p>Wins: <span id="statWins">0</span></p>
    <p>Losses: <span id="statLosses">0</span></p>
    <p>Win Rate: <span id="statWinRate">0%</span></p>
  </div>

  <script>
    async function fetchTradeLogs() {
      const res = await fetch("/logs");
      if (!res.ok) return;
      const logs = await res.json();
      const ul = document.getElementById("tradeLogList");
      ul.innerHTML = logs.map(t => {
        const resultText = t.result ? t.result.toUpperCase() : "Pending";
        return `<li><b>${new Date(t.timestamp).toLocaleString()}</b> - ${t.pair} - $${t.amount} - Expiry: ${t.expiry}min - Result: <i>${resultText}</i></li>`;
      }).join("");
    }

    async function fetchStats() {
      const res = await fetch("/stats");
      if (!res.ok) return;
      const stats = await res.json();
      document.getElementById("statTotal").textContent = stats.total;
      document.getElementById("statWins").textContent = stats.wins;
      document.getElementById("statLosses").textContent = stats.losses;
      document.getElementById("statWinRate").textContent = stats.winRate + "%";
    }

    document.getElementById("tradeForm").onsubmit = async (e) => {
      e.preventDefault();

      const pair = e.target.pair.value;
      const expiry = e.target.expiry.value;
      const amount = e.target.amount.value;
      const stopLoss = e.target.stopLoss.value;
      const takeProfit = e.target.takeProfit.value;

      const body = { pair, expiry, amount };
      if (stopLoss) body.stopLoss = Number(stopLoss);
      if (takeProfit) body.takeProfit = Number(takeProfit);

      const res = await fetch("/trade", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      const json = await res.json();
      if (json.success) {
        alert("Trade placed!");
        fetchTradeLogs();
        fetchStats();
      } else {
        alert("Error: " + json.message);
      }
    };

    // Capture chart + send
    document.getElementById("captureBtn").onclick = async () => {
      const chartUrl = prompt("Enter Chart URL:");
      if (!chartUrl) return alert("URL required");

      const statusDiv = document.getElementById("captureStatus");
      const lastCapture = document.getElementById("lastCapture");
      lastCapture.style.display = "none";
      lastCapture.src = "";
      statusDiv.textContent = "Starting capture...";

      try {
        const res = await fetch("/start-capture", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url: chartUrl }),
        });

        if (!res.ok) throw new Error("Failed to start capture");

        // Poll capture status
        let done = false;
        while (!done) {
          await new Promise(r => setTimeout(r, 2000));
          const statusRes = await fetch("/capture-status");
          const status = await statusRes.json();
          statusDiv.textContent = status.message || "Working...";

          if (status.state === "done") {
            done = true;
            lastCapture.src = status.lastImagePath;
            lastCapture.style.display = "block";
            alert("Capture complete and sent!");
          } else if (status.state === "error") {
            done = true;
            alert("Error: " + status.message);
          }
        }
      } catch (err) {
        statusDiv.textContent = "Error: " + err.message;
        alert("Error: " + err.message);
      }
    };

    // Update trade result button
    document.getElementById("updateResultBtn").onclick = async () => {
      const timestamp = Number(document.getElementById("tradeTimestamp").value);
      const result = document.getElementById("tradeResult").value;
      if (!timestamp) return alert("Enter a valid timestamp");

      try {
        const res = await fetch("/trade-result", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ timestamp, result }),
        });
        const json = await res.json();
        if (json.success) {
          alert(json.message);
          fetchTradeLogs();
          fetchStats();
        } else {
          alert("Error: " + json.message);
        }
      } catch (e) {
        alert("Network error: " + e.message);
      }
    };

    // Load logs + stats initially & every 10 sec
    async function refreshUI() {
      await fetchTradeLogs();
      await fetchStats();
    }
    refreshUI();
    setInterval(refreshUI, 10000);
  </script>
</body>
</html>
